name: Copilot Auto-Resolve

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
  schedule:
    - cron: '23 */3 * * *'

permissions:
  contents: read
  pull-requests: write

jobs:
  resolve-current-pr:
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Resolve addressed Copilot review threads (current PR)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python .github/scripts/copilot_autoresolve.py \
            --owner "${{ github.repository_owner }}" \
            --repo "${{ github.event.repository.name }}" \
            --number "${{ github.event.pull_request.number }}"

  resolve-open-prs:
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Resolve addressed Copilot review threads (all open PRs)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          prs=$(gh pr list --repo "$owner/$repo" --state open --limit 100 --json number -q '.[].number')
          if [ -z "$prs" ]; then
            echo "No open PRs."
            exit 0
          fi
          for pr in $prs; do
            echo "--- PR #$pr ---"
            python .github/scripts/copilot_autoresolve.py --owner "$owner" --repo "$repo" --number "$pr"
          done
